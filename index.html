<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­æ°´æº–æ¸¬é‡ç´€éŒ„è¡¨ (è‡ªå‹•æª¢æ ¸ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .container { max-width: 900px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .table thead { background-color: #2c3e50; color: white; }
        .summary-box { background-color: #e8f4fd; border-left: 5px solid #2980b9; padding: 15px; margin-top: 20px; }
        .btn-group-custom { margin-bottom: 20px; gap: 10px; display: flex; flex-wrap: wrap; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">ç›´æ¥æ°´æº–æ¸¬é‡ç´€éŒ„è¡¨</h2>
    
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <label class="form-label fw-bold">èµ·å§‹å·²çŸ¥é«˜ç¨‹ (BM_Start)</label>
            <input type="number" id="startHeight" class="form-control" value="0.000" step="0.001" oninput="calculate()">
        </div>
    </div>

    <div class="btn-group-custom">
        <button class="btn btn-primary" onclick="addRow()">â• æ–°å¢æ¸¬é» (è½‰é»)</button>
        <button class="btn btn-success" onclick="exportToCSV()">ğŸ“Š åŒ¯å‡º Excel (CSV)</button>
        <button class="btn btn-outline-danger" onclick="resetTable()">ğŸ”„ é‡ç½®è¡¨æ ¼</button>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
            <thead>
                <tr>
                    <th width="15%">æ¸¬é»</th>
                    <th width="20%">å¾Œè¦– (BS)</th>
                    <th width="20%">å‰è¦– (FS)</th>
                    <th width="20%">é«˜å„€é«˜ (HI)</th>
                    <th width="25%">é«˜ç¨‹ (Elev)</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td><input type="text" class="form-control pt-name" value="BM1"></td>
                    <td><input type="number" class="form-control bs" step="0.001" oninput="calculate()"></td>
                    <td><input type="number" class="form-control fs" value="-" disabled></td>
                    <td class="hi"></td>
                    <td class="elev">0.000</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="summary-box">
        <h5 class="fw-bold">æ°´æº–è¨ˆç®—æª¢æ ¸ (Summary Check)</h5>
        <div class="row text-center mt-3">
            <div class="col-4">Î£BS: <span id="sumBS" class="text-primary fw-bold">0.000</span></div>
            <div class="col-4">Î£FS: <span id="sumFS" class="text-danger fw-bold">0.000</span></div>
            <div class="col-4">é«˜å·® (Î”H): <span id="diffH" class="fw-bold">0.000</span></div>
        </div>
    </div>
</div>

<script>
    function addRow() {
        const tbody = document.getElementById('tableBody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" class="form-control pt-name" placeholder="TP"></td>
            <td><input type="number" class="form-control bs" step="0.001" oninput="calculate()"></td>
            <td><input type="number" class="form-control fs" step="0.001" oninput="calculate()"></td>
            <td class="hi text-muted"></td>
            <td class="elev fw-bold"></td>
        `;
        tbody.appendChild(row);
    }

    function calculate() {
        const startH = parseFloat(document.getElementById('startHeight').value) || 0;
        const rows = document.querySelectorAll('#tableBody tr');
        
        let currentElev = startH;
        let totalBS = 0;
        let totalFS = 0;

        rows.forEach((row, index) => {
            const bsInput = row.querySelector('.bs');
            const fsInput = row.querySelector('.fs');
            const hiCell = row.querySelector('.hi');
            const elevCell = row.querySelector('.elev');

            const bs = parseFloat(bsInput.value);
            const fs = parseFloat(fsInput.value);

            if (index === 0) {
                // ç¬¬ä¸€ç«™ (èµ·é»)
                elevCell.innerText = startH.toFixed(3);
                if (!isNaN(bs)) {
                    const hi = startH + bs;
                    hiCell.innerText = hi.toFixed(3);
                    row.dataset.hi = hi;
                    totalBS += bs;
                } else {
                    hiCell.innerText = "";
                    delete row.dataset.hi;
                }
            } else {
                // è½‰é»èˆ‡çµ‚é»
                const prevHi = parseFloat(rows[index - 1].dataset.hi);
                
                if (!isNaN(fs) && !isNaN(prevHi)) {
                    currentElev = prevHi - fs;
                    elevCell.innerText = currentElev.toFixed(3);
                    totalFS += fs;

                    if (!isNaN(bs)) {
                        const hi = currentElev + bs;
                        hiCell.innerText = hi.toFixed(3);
                        row.dataset.hi = hi;
                        totalBS += bs;
                    } else {
                        hiCell.innerText = "";
                        delete row.dataset.hi;
                    }
                } else {
                    elevCell.innerText = "";
                    hiCell.innerText = "";
                    delete row.dataset.hi;
                }
            }
        });

        // æ›´æ–°æª¢æ ¸æ•¸å€¼
        document.getElementById('sumBS').innerText = totalBS.toFixed(3);
        document.getElementById('sumFS').innerText = totalFS.toFixed(3);
        document.getElementById('diffH').innerText = (totalBS - totalFS).toFixed(3);
    }

    function exportToCSV() {
        let csv = '\uFEFFæ¸¬é»,å¾Œè¦–(BS),å‰è¦–(FS),é«˜å„€é«˜(HI),é«˜ç¨‹(Elev)\n';
        const rows = document.querySelectorAll('#tableBody tr');
        
        rows.forEach(row => {
            const name = row.querySelector('.pt-name').value;
            const bs = row.querySelector('.bs').value;
            const fs = row.querySelector('.fs').value;
            const hi = row.querySelector('.hi').innerText;
            const elev = row.querySelector('.elev').innerText;
            csv += `${name},${bs},${fs},${hi},${elev}\n`;
        });

        // åŠ å…¥çµ±è¨ˆè³‡è¨Š
        csv += `\nç¸½è¨ˆ,Î£BS: ${document.getElementById('sumBS').innerText},Î£FS: ${document.getElementById('sumFS').innerText},é«˜å·®: ${document.getElementById('diffH').innerText}\n`;

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `æ¸¬é‡ç´€éŒ„_${new Date().toLocaleDateString()}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function resetTable() {
        if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰æ•¸æ“šå—ï¼Ÿ")) location.reload();
    }
</script>

</body>
</html>
