<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ˆæ¥­æ°´æº–æ¸¬é‡ç³»çµ± - æ™ºæ…§å‘½åç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-dark: #1a2a3a; }
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 80px; }
        .header-section { background: var(--primary-dark); color: white; padding: 20px; border-radius: 0 0 15px 15px; margin-bottom: 15px; }
        .table-container { background: white; padding: 10px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .hi-col { background-color: #f8f9fa !important; color: #0d6efd; font-weight: bold; }
        .elev-col { background-color: #fff0f5 !important; color: #d63384; font-weight: bold; }
        
        /* æ‰‹æ©Ÿè‡ªé©æ‡‰å„ªåŒ– */
        @media (max-width: 768px) {
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            table { min-width: 850px; }
            th:first-child, td:first-child {
                position: sticky; left: 0; background-color: white !important; z-index: 10;
                border-right: 2px solid #dee2e6; min-width: 90px;
            }
        }

        .summary-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; border-top: 3px solid var(--primary-dark);
            padding: 12px; z-index: 1000; display: flex;
            justify-content: space-around; font-weight: bold; font-size: 0.85rem;
        }
        .status-ok { color: #198754; }
        .status-fail { color: #dc3545; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body onload="loadSavedData()">

<div class="container-fluid">
    <div class="header-section shadow">
        <h4 class="text-center mb-3">å°ˆæ¥­æ°´æº–æ¸¬é‡ç³»çµ±</h4>
        <div class="row g-2">
            <div class="col-md-3 col-6">
                <label class="form-label small text-light">å®¹è¨±èª¤å·®æ¨™æº–</label>
                <select id="toleranceGrade" class="form-select form-select-sm" onchange="calculate(); saveAllData();">
                    <option value="6">æ™®é€š ($\pm 6\sqrt{n}$ mm)</option>
                    <option value="3">ä¸‰ç­‰ ($\pm 3\sqrt{n}$ mm)</option>
                    <option value="12">ä¾å…¬é‡Œ ($\pm 12\sqrt{K}$ mm)</option>
                </select>
            </div>
            <div class="col-md-3 col-6">
                <label class="form-label small text-light">èµ·é» H1</label>
                <input type="number" id="startHeight" class="form-control form-control-sm" value="0.000" step="0.001" oninput="calculate(); saveAllData();">
            </div>
            <div class="col-md-3 col-6">
                <label class="form-label small text-light">æ¸¬é‡é¡å‹</label>
                <select id="surveyType" class="form-select form-select-sm" onchange="toggleEndHeight(); saveAllData();">
                    <option value="é–‰åˆæ°´æº–æ¸¬é‡">é–‰åˆæ°´æº–æ¸¬é‡</option>
                    <option value="é™„åˆæ°´æº–æ¸¬é‡">é™„åˆæ°´æº–æ¸¬é‡</option>
                </select>
            </div>
            <div id="endHeightDiv" class="col-md-3 col-6" style="display:none;">
                <label class="form-label small text-warning">çµ‚é» H2</label>
                <input type="number" id="endHeight" class="form-control form-control-sm border-warning" value="0.000" step="0.001" oninput="calculate(); saveAllData();">
            </div>
        </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mb-3">
        <button class="btn btn-primary btn-sm" onclick="addRow('TP')">â• è½‰é» (TP)</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="addRow('IFS')">ğŸ‘ï¸ é–“è¦– (IFS)</button>
        <button class="btn btn-warning btn-sm fw-bold" onclick="adjustErrors()">âš–ï¸ æ¬Šé‡å¹³å·®</button>
        <button class="btn btn-success btn-sm" onclick="exportToCSV()">ğŸ’¾ å°å‡ºæˆæœ</button>
        <button class="btn btn-link btn-sm text-danger ms-auto" onclick="resetTable()">å…¨è¡¨é‡ç½®</button>
    </div>

    <div class="table-container shadow-sm">
        <div class="table-responsive">
            <table class="table table-bordered align-middle text-center" id="surveyTable">
                <thead class="table-dark small">
                    <tr>
                        <th>æ¸¬é»</th>
                        <th>BS</th>
                        <th>IFS</th>
                        <th>FS</th>
                        <th>HI</th>
                        <th>Elev</th>
                        <th>å‚™è¨» (L=è·é›¢)</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="summary-bar shadow">
    <div id="checkStations">æ¸¬ç«™: 0</div>
    <div id="checkWh">èª¤å·®: 0.000</div>
    <div id="checkLimit">é™å·®: Â±0.000</div>
    <div id="checkStatus" class="fw-bold">ç‹€æ…‹: -</div>
</div>

<script>
    // --- å„²å­˜é‚è¼¯ ---
    function saveAllData() {
        const rows = [];
        document.querySelectorAll('#tableBody tr').forEach(row => {
            rows.push({
                type: row.dataset.type,
                name: row.querySelector('.pt-name').value,
                bs: row.querySelector('.bs').value,
                ifs: row.querySelector('.ifs').value,
                fs: row.querySelector('.fs').value,
                note: row.querySelector('.note').value
            });
        });
        localStorage.setItem('surveySmartBackup', JSON.stringify({
            toleranceGrade: document.getElementById('toleranceGrade').value,
            surveyType: document.getElementById('surveyType').value,
            startHeight: document.getElementById('startHeight').value,
            endHeight: document.getElementById('endHeight').value,
            rows: rows
        }));
    }

    function loadSavedData() {
        const saved = localStorage.getItem('surveySmartBackup');
        if (saved) {
            const data = JSON.parse(saved);
            document.getElementById('toleranceGrade').value = data.toleranceGrade || "6";
            document.getElementById('surveyType').value = data.surveyType;
            document.getElementById('startHeight').value = data.startHeight;
            document.getElementById('endHeight').value = data.endHeight;
            toggleEndHeight();
            document.getElementById('table<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ˆæ¥­æ°´æº–æ¸¬é‡ç³»çµ± - æ™ºæ…§å‘½åç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-dark: #1a2a3a; }
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 80px; }
        .header-section { background: var(--primary-dark); color: white; padding: 20px; border-radius: 0 0 15px 15px; margin-bottom: 15px; }
        .table-container { background: white; padding: 10px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .hi-col { background-color: #f8f9fa !important; color: #0d6efd; font-weight: bold; }
        .elev-col { background-color: #fff0f5 !important; color: #d63384; font-weight: bold; }
        
        /* æ‰‹æ©Ÿè‡ªé©æ‡‰å„ªåŒ– */
        @media (max-width: 768px) {
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            table { min-width: 850px; }
            th:first-child, td:first-child {
                position: sticky; left: 0; background-color: white !important; z-index: 10;
                border-right: 2px solid #dee2e6; min-width: 90px;
            }
        }

        .summary-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; border-top: 3px solid var(--primary-dark);
            padding: 12px; z-index: 1000; display: flex;
            justify-content: space-around; font-weight: bold; font-size: 0.85rem;
        }
        .status-ok { color: #198754; }
        .status-fail { color: #dc3545; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body onload="loadSavedData()">

<div class="container-fluid">
    <div class="header-section shadow">
        <h4 class="text-center mb-3">å°ˆæ¥­æ°´æº–æ¸¬é‡ç³»çµ±</h4>
        <div class="row g-2">
            <div class="col-md-3 col-6">
                <label class="form-label small text-light">å®¹è¨±èª¤å·®æ¨™æº–</label>
                <select id="toleranceGrade" class="form-select form-select-sm" onchange="calculate(); saveAllData();">
                    <option value="6">æ™®é€š ($\pm 6\sqrt{n}$ mm)</option>
                    <option value="3">ä¸‰ç­‰ ($\pm 3\sqrt{n}$ mm)</option>
                    <option value="12">ä¾å…¬é‡Œ ($\pm 12\sqrt{K}$ mm)</option>
                </select>
            </div>
            <div class="col-md-3 col-6">
                <label class="form-label small text-light">èµ·é» H1</label>
                <input type="number" id="startHeight" class="form-control form-control-sm" value="0.000" step="0.001" oninput="calculate(); saveAllData();">
            </div>
            <div class="col-md-3 col-6">
                <label class="form-label small text-light">æ¸¬é‡é¡å‹</label>
                <select id="surveyType" class="form-select form-select-sm" onchange="toggleEndHeight(); saveAllData();">
                    <option value="é–‰åˆæ°´æº–æ¸¬é‡">é–‰åˆæ°´æº–æ¸¬é‡</option>
                    <option value="é™„åˆæ°´æº–æ¸¬é‡">é™„åˆæ°´æº–æ¸¬é‡</option>
                </select>
            </div>
            <div id="endHeightDiv" class="col-md-3 col-6" style="display:none;">
                <label class="form-label small text-warning">çµ‚é» H2</label>
                <input type="number" id="endHeight" class="form-control form-control-sm border-warning" value="0.000" step="0.001" oninput="calculate(); saveAllData();">
            </div>
        </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mb-3">
        <button class="btn btn-primary btn-sm" onclick="addRow('TP')">â• è½‰é» (TP)</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="addRow('IFS')">ğŸ‘ï¸ é–“è¦– (IFS)</button>
        <button class="btn btn-warning btn-sm fw-bold" onclick="adjustErrors()">âš–ï¸ æ¬Šé‡å¹³å·®</button>
        <button class="btn btn-success btn-sm" onclick="exportToCSV()">ğŸ’¾ å°å‡ºæˆæœ</button>
        <button class="btn btn-link btn-sm text-danger ms-auto" onclick="resetTable()">å…¨è¡¨é‡ç½®</button>
    </div>

    <div class="table-container shadow-sm">
        <div class="table-responsive">
            <table class="table table-bordered align-middle text-center" id="surveyTable">
                <thead class="table-dark small">
                    <tr>
                        <th>æ¸¬é»</th>
                        <th>BS</th>
                        <th>IFS</th>
                        <th>FS</th>
                        <th>HI</th>
                        <th>Elev</th>
                        <th>å‚™è¨» (L=è·é›¢)</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="summary-bar shadow">
    <div id="checkStations">æ¸¬ç«™: 0</div>
    <div id="checkWh">èª¤å·®: 0.000</div>
    <div id="checkLimit">é™å·®: Â±0.000</div>
    <div id="checkStatus" class="fw-bold">ç‹€æ…‹: -</div>
</div>

<script>
    // --- å„²å­˜é‚è¼¯ ---
    function saveAllData() {
        const rows = [];
        document.querySelectorAll('#tableBody tr').forEach(row => {
            rows.push({
                type: row.dataset.type,
                name: row.querySelector('.pt-name').value,
                bs: row.querySelector('.bs').value,
                ifs: row.querySelector('.ifs').value,
                fs: row.querySelector('.fs').value,
                note: row.querySelector('.note').value
            });
        });
        localStorage.setItem('surveySmartBackup', JSON.stringify({
            toleranceGrade: document.getElementById('toleranceGrade').value,
            surveyType: document.getElementById('surveyType').value,
            startHeight: document.getElementById('startHeight').value,
            endHeight: document.getElementById('endHeight').value,
            rows: rows
        }));
    }

    function loadSavedData() {
        const saved = localStorage.getItem('surveySmartBackup');
        if (saved) {
            const data = JSON.parse(saved);
            document.getElementById('toleranceGrade').value = data.toleranceGrade || "6";
            document.getElementById('surveyType').value = data.surveyType;
            document.getElementById('startHeight').value = data.startHeight;
            document.getElementById('endHeight').value = data.endHeight;
            toggleEndHeight();
            document.getElementById('table
